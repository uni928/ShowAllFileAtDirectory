<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>拡張子で分類して表示</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    th { background: #eee; }
    button { margin: 5px 0; }
  </style>
</head>
<body>

<h2>📂 拡張子で分類されたファイル一覧</h2>
<button id="pick">フォルダを選択</button>
<div id="view"></div>

<script>
  const pickBtn = document.getElementById('pick');
  const viewDiv = document.getElementById('view');
  let allFiles = [];
  let extGroups = {};

  pickBtn.addEventListener('click', async () => {
    try {
      const dirHandle = await window.showDirectoryPicker();
      allFiles = [];
      extGroups = {};
      await readAllFiles(dirHandle);
      groupByExtension();
      renderExtensionTable();
    } catch (e) {
      alert('キャンセルされました。');
    }
  });

  async function readAllFiles(dirHandle, path = '') {
    for await (const [name, handle] of dirHandle.entries()) {
      const fullPath = `${path}${name}`;
      if (handle.kind === 'file') {
        allFiles.push({ name, path: fullPath, handle });
      } else if (handle.kind === 'directory') {
        await readAllFiles(handle, `${fullPath}/`);
      }
    }
  }

  function groupByExtension() {
    extGroups = {};
    for (const file of allFiles) {
      const ext = getExt(file.name);
      if (!extGroups[ext]) extGroups[ext] = [];
      extGroups[ext].push(file);
    }
  }

  function getExt(filename) {
    const dot = filename.lastIndexOf('.');
    return dot === -1 ? '(no ext)' : filename.slice(dot).toLowerCase();
  }

  function renderExtensionTable() {
    viewDiv.innerHTML = '<h3>拡張子一覧</h3>';
    const table = document.createElement('table');
    table.innerHTML = `
      <thead><tr><th>拡張子</th><th>件数</th><th>操作</th></tr></thead>
      <tbody>
        ${Object.entries(extGroups).map(([ext, files]) => `
          <tr>
            <td>${ext}</td>
            <td>${files.length}</td>
            <td><button onclick="renderFileTable('${ext}')">この拡張子を開く</button></td>
          </tr>
        `).join('')}
      </tbody>
    `;
    viewDiv.appendChild(table);
  }

  window.renderFileTable = function(ext) {
    const files = extGroups[ext];
    viewDiv.innerHTML = `<h3>${ext} のファイル一覧</h3><button onclick="renderExtensionTable()">← 戻る</button>`;
    const table = document.createElement('table');
    table.innerHTML = `
      <thead><tr><th>ファイル名</th><th>パス</th><th>操作</th></tr></thead>
      <tbody>
        ${files.map((file, idx) => `
          <tr>
            <td>${file.name}</td>
            <td>${file.path}</td>
            <td><button onclick="previewFile(${allFiles.indexOf(file)})">プレビュー</button></td>
          </tr>
        `).join('')}
      </tbody>
    `;
    viewDiv.appendChild(table);
  };

  async function previewFile(index) {
    const file = await allFiles[index].handle.getFile();
    const content = await file.text();
    const html = `
      <html><head><meta charset="UTF-8"><title>${file.name}</title></head>
      <body><pre style="white-space:pre-wrap;">${escapeHtml(content)}</pre></body>
      </html>
    `;
    const newTab = window.open("", "_blank");
    if (newTab) {
      newTab.document.open();
      newTab.document.write(html);
      newTab.document.close();
    } else {
      alert("新しいタブを開けませんでした。");
    }
  }

  function escapeHtml(str) {
    return str.replace(/[&<>'"]/g, c =>
      ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' })[c]
    );
  }
</script>

</body>
</html>
